<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WOMBAT PHOTOMETRY PIPELINE - Validate & Publish</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background-color: #0d0d0d;
            padding: 20px 30px;
            border-bottom: 2px solid #333;
        }
        
        .title {
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 2px;
            margin-bottom: 10px;
            color: #fff;
        }
        
        .subtitle {
            font-size: 14px;
            color: #888;
            margin-bottom: 15px;
        }
        
        .nav-links {
            margin-top: 10px;
        }
        
        .nav-link {
            display: inline-block;
            padding: 8px 16px;
            background-color: #2a2a2a;
            border: 1px solid #444;
            color: #e0e0e0;
            text-decoration: none;
            border-radius: 4px;
            margin-right: 10px;
            font-size: 13px;
            font-family: Arial, sans-serif;
        }
        
        .nav-link:hover {
            background-color: #353535;
            border-color: #555;
        }
        
        .main-layout {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 20px;
            flex: 1;
            padding: 20px 30px;
            overflow: hidden;
        }
        
        .targets-panel {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            background-color: #0d0d0d;
            color: #fff;
            padding: 15px;
            font-weight: bold;
            font-size: 14px;
            border-bottom: 2px solid #333;
        }
        
        .targets-list {
            flex: 1;
            overflow-y: auto;
            background-color: #1e1e1e;
        }
        
        .target-item {
            padding: 15px;
            border-bottom: 1px solid #2a2a2a;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .target-item:hover {
            background-color: #252525;
        }
        
        .target-item.selected {
            background-color: #2a3f2a;
            border-left: 4px solid #4CAF50;
        }
        
        .target-name {
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .target-details {
            font-size: 12px;
            color: #888;
        }
        
        .lightcurve-panel {
            background-color: #1e1e1e;
            border: 1px solid #333;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .plot-container {
            flex: 1;
            padding: 20px;
            overflow: hidden;
        }
        
        #lightcurve-plot {
            width: 100%;
            height: 100%;
        }
        
        .controls {
            padding: 20px;
            background-color: #252525;
            border-top: 2px solid #333;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .btn {
            padding: 10px 20px;
            border: 1px solid #444;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
            font-family: Arial, sans-serif;
            transition: all 0.2s;
        }
        
        .btn:hover:not(:disabled) {
            border-color: #555;
        }
        
        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .btn-reject {
            background-color: #8B0000;
            color: white;
            border-color: #A52A2A;
        }
        
        .btn-reject:hover:not(:disabled) {
            background-color: #A52A2A;
        }
        
        .btn-approve {
            background-color: #2d5016;
            color: white;
            border-color: #4CAF50;
        }
        
        .btn-approve:hover:not(:disabled) {
            background-color: #3d6821;
        }
        
        .btn-submit {
            background-color: #1a4d7a;
            color: white;
            border-color: #2196F3;
        }
        
        .btn-submit:hover:not(:disabled) {
            background-color: #2563a0;
        }
        
        .btn-secondary {
            background-color: #2a2a2a;
            color: #e0e0e0;
            border-color: #444;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background-color: #353535;
        }
        
        .info-banner {
            background-color: #3a2f1a;
            border: 1px solid #5a4a2a;
            color: #ffcc00;
            padding: 12px 15px;
            border-radius: 4px;
            margin-bottom: 10px;
            display: none;
            font-size: 13px;
        }
        
        .info-banner.show {
            display: block;
        }
        
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            margin-left: 5px;
            font-weight: bold;
        }
        
        .status-approved {
            background-color: #2d5016;
            color: #90EE90;
            border: 1px solid #4CAF50;
        }
        
        .status-submitted {
            background-color: #1a3a4d;
            color: #87CEEB;
            border: 1px solid #2196F3;
        }
        
        .rejected-count {
            margin-left: auto;
            padding: 5px 10px;
            background-color: #8B0000;
            color: white;
            border-radius: 3px;
            font-size: 12px;
            border: 1px solid #A52A2A;
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            padding: 40px;
            text-align: center;
        }
        
        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">WOMBAT PHOTOMETRY PIPELINE</div>
            <div class="subtitle">Validate & Publish Photometry</div>
            
            <div class="nav-links">
                <a href="/" class="nav-link">‚Üê Database Views</a>
            </div>
        </div>
        
        <div class="info-banner" id="info-banner"></div>
        
        <div class="main-layout">
            <!-- Targets List Panel -->
            <div class="targets-panel">
                <div class="panel-header">
                    Targets Ready for Validation
                </div>
                <div class="targets-list" id="targets-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <p>Loading targets...</p>
                    </div>
                </div>
            </div>
            
            <!-- Lightcurve Panel -->
            <div class="lightcurve-panel">
                <div class="plot-container">
                    <div id="lightcurve-plot"></div>
                </div>
                <div class="controls" id="controls" style="display: none;">
                    <button class="btn btn-secondary" id="btn-clear-selection">Clear Selection</button>
                    <button class="btn btn-reject" id="btn-reject">‚ùå Reject</button>
                    <button class="btn btn-approve" id="btn-approve">‚úì Approve</button>
                    <button class="btn btn-submit" id="btn-submit" style="display: none;">üì§ Push to AAVSO</button>
                    <span class="rejected-count" id="rejected-count" style="display: none;">0 points rejected</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTarget = null;
        let lightcurveData = null;
        let rejectedPoints = new Set();
        
        // Load targets on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadTargets();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            document.getElementById('btn-reject').addEventListener('click', rejectTarget);
            document.getElementById('btn-approve').addEventListener('click', approveTarget);
            document.getElementById('btn-submit').addEventListener('click', submitToAAVSO);
            document.getElementById('btn-clear-selection').addEventListener('click', clearSelection);
        }
        
        async function loadTargets() {
            try {
                const response = await fetch('/api/targets/validate');
                const targets = await response.json();
                
                const targetsList = document.getElementById('targets-list');
                
                if (targets.length === 0) {
                    targetsList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">‚úÖ</div>
                            <p>No targets awaiting validation</p>
                        </div>
                    `;
                    return;
                }
                
                targetsList.innerHTML = targets.map(target => {
                    const statusBadge = target.submitted === 'approved' ? 
                        '<span class="status-badge status-approved">Approved</span>' :
                        target.submitted === 'submitted' ?
                        '<span class="status-badge status-submitted">Submitted</span>' : '';
                    
                    return `
                        <div class="target-item" 
                             data-date="${target.date}" 
                             data-name="${target.target_name}" 
                             data-filter="${target.filter}"
                             onclick="selectTarget('${target.date}', '${target.target_name}', '${target.filter}')">
                            <div class="target-name">${target.auid || target.target_name} ${statusBadge}</div>
                            <div class="target-details">
                                üìÖ ${target.date} | üîç ${target.filter} filter | ${target.num_images || 0} images
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading targets:', error);
                showInfo('Error loading targets: ' + error.message, 'error');
            }
        }
        
        async function selectTarget(date, targetName, filter) {
            currentTarget = { date, target_name: targetName, filter };
            rejectedPoints.clear();
            
            // Update UI selection
            document.querySelectorAll('.target-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // Show controls
            document.getElementById('controls').style.display = 'flex';
            document.getElementById('btn-submit').style.display = 'none';
            updateRejectedCount();
            
            // Load lightcurve data
            try {
                const response = await fetch(`/api/lightcurve/${date}/${targetName}/${filter}`);
                lightcurveData = await response.json();
                
                if (lightcurveData.error) {
                    showInfo('Error: ' + lightcurveData.error, 'error');
                    return;
                }
                
                plotLightcurve();
                
            } catch (error) {
                console.error('Error loading lightcurve:', error);
                showInfo('Error loading lightcurve: ' + error.message, 'error');
            }
        }
        
        function plotLightcurve() {
            if (!lightcurveData) return;
            
            // Calculate HJD offset for cleaner display
            const hjdOffset = Math.floor(lightcurveData.T1[0].hjd);
            
            // Filter out points rejected by sigma clipping AND user rejections
            const t1Data = lightcurveData.T1.filter(p => !p.rejected && !rejectedPoints.has(`T1_${p.index}`));
            const t2Data = lightcurveData.T2.filter(p => !p.rejected && !rejectedPoints.has(`T2_${p.index}`));
            
            // Show both sigma-clipped and user-rejected points
            const t1Rejected = lightcurveData.T1.filter(p => p.rejected || rejectedPoints.has(`T1_${p.index}`));
            const t2Rejected = lightcurveData.T2.filter(p => p.rejected || rejectedPoints.has(`T2_${p.index}`));
            
            const traces = [
                // T1 - Variable (blue)
                {
                    name: 'T1 (Variable)',
                    x: t1Data.map(p => p.hjd - hjdOffset),
                    y: t1Data.map(p => p.mag),
                    error_y: {
                        type: 'data',
                        array: t1Data.map(p => p.err),
                        visible: true
                    },
                    mode: 'markers',
                    marker: {
                        color: '#3498db',
                        size: 8,
                        line: { color: '#2980b9', width: 1 }
                    },
                    type: 'scatter',
                    customdata: t1Data.map(p => ({ star: 'T1', index: p.index }))
                },
                // T2 - Check star (red)
                {
                    name: 'T2 (Check)',
                    x: t2Data.map(p => p.hjd - hjdOffset),
                    y: t2Data.map(p => p.mag),
                    error_y: {
                        type: 'data',
                        array: t2Data.map(p => p.err),
                        visible: true
                    },
                    mode: 'markers',
                    marker: {
                        color: '#e74c3c',
                        size: 8,
                        line: { color: '#c0392b', width: 1 }
                    },
                    type: 'scatter',
                    customdata: t2Data.map(p => ({ star: 'T2', index: p.index }))
                }
            ];
            
            // Add rejected points as gray crosses
            if (t1Rejected.length > 0) {
                traces.push({
                    name: 'T1 (Rejected)',
                    x: t1Rejected.map(p => p.hjd - hjdOffset),
                    y: t1Rejected.map(p => p.mag),
                    mode: 'markers',
                    marker: {
                        color: '#95a5a6',
                        size: 10,
                        symbol: 'x',
                        line: { width: 2 }
                    },
                    type: 'scatter',
                    showlegend: true
                });
            }
            
            if (t2Rejected.length > 0) {
                traces.push({
                    name: 'T2 (Rejected)',
                    x: t2Rejected.map(p => p.hjd - hjdOffset),
                    y: t2Rejected.map(p => p.mag),
                    mode: 'markers',
                    marker: {
                        color: '#7f8c8d',
                        size: 10,
                        symbol: 'x',
                        line: { width: 2 }
                    },
                    type: 'scatter',
                    showlegend: true
                });
            }
            
            const layout = {
                title: {
                    text: `${lightcurveData.target_name} - Standardised`,
                    font: { color: '#e0e0e0' }
                },
                xaxis: {
                    title: `HJD - ${hjdOffset}`,
                    showgrid: true,
                    zeroline: false,
                    gridcolor: '#333',
                    color: '#e0e0e0'
                },
                yaxis: {
                    title: `Magnitude (${lightcurveData.filter})`,
                    autorange: false,  // Disable autorange since we set it manually
                    showgrid: true,
                    zeroline: false,
                    gridcolor: '#333',
                    color: '#e0e0e0'
                },
                hovermode: 'closest',
                dragmode: 'select',  // Enable box selection
                showlegend: true,
                legend: {
                    x: 0.02,
                    y: 0.98,
                    bgcolor: 'rgba(0,0,0,0.7)',
                    bordercolor: '#444',
                    borderwidth: 1,
                    font: { color: '#e0e0e0' }
                },
                plot_bgcolor: '#1a1a1a',
                paper_bgcolor: '#1e1e1e',
                font: {
                    color: '#e0e0e0'
                }
            };
            
            const config = {
                displayModeBar: true,
                modeBarButtonsToAdd: ['select2d', 'lasso2d'],
                modeBarButtonsToRemove: ['toImage'],
                displaylogo: false
            };
            
            // Calculate axis ranges based on remaining (non-rejected) data
            const allT1 = t1Data.map(p => p.mag);
            const allT2 = t2Data.map(p => p.mag);
            const allMags = [...allT1, ...allT2];
            
            if (allMags.length > 0) {
                const minMag = Math.min(...allMags);
                const maxMag = Math.max(...allMags);
                const magRange = maxMag - minMag;
                const padding = magRange * 0.1;
                
                // Update y-axis range (reversed because magnitudes)
                layout.yaxis.range = [maxMag + padding, minMag - padding];
            }
            
            // Update title to show rejection count if any points rejected
            if (rejectedPoints.size > 0) {
                const numRejected = rejectedPoints.size / 2;  // Divide by 2 since we reject both T1 and T2
                layout.title.text = `${lightcurveData.target_name} - Standardised [${numRejected} points rejected]`;
            }
            
            const plotDiv = document.getElementById('lightcurve-plot');
            Plotly.newPlot(plotDiv, traces, layout, config);
            
            // Handle point selection (for rejection)
            plotDiv.on('plotly_selected', function(eventData) {
                if (eventData && eventData.points) {
                    eventData.points.forEach(point => {
                        const customData = point.data.customdata[point.pointIndex];
                        const dataIndex = customData.index;
                        // Reject both T1 and T2 at the same index (synchronized rejection)
                        rejectedPoints.add(`T1_${dataIndex}`);
                        rejectedPoints.add(`T2_${dataIndex}`);
                    });
                    updateRejectedCount();
                    plotLightcurve();  // Replot to show rejected points
                }
            });
            
            // Handle single point click
            plotDiv.on('plotly_click', function(eventData) {
                if (eventData.points.length > 0) {
                    const point = eventData.points[0];
                    const customData = point.data.customdata[point.pointIndex];
                    const key = `${customData.star}_${customData.index}`;
                    
                    if (rejectedPoints.has(key)) {
                        rejectedPoints.delete(key);
                    } else {
                        rejectedPoints.add(key);
                    }
                    updateRejectedCount();
                    plotLightcurve();
                }
            });
        }
        
        function updateRejectedCount() {
            const countEl = document.getElementById('rejected-count');
            const count = rejectedPoints.size;
            
            if (count > 0) {
                countEl.textContent = `${count} point${count > 1 ? 's' : ''} rejected`;
                countEl.style.display = 'block';
            } else {
                countEl.style.display = 'none';
            }
        }
        
        async function rejectTarget() {
            if (!currentTarget) return;
            
            if (!confirm('Reject this target? This will mark it as user-rejected and it will not be submitted.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/target/update_status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: currentTarget.date,
                        target_name: currentTarget.target_name,
                        filter: currentTarget.filter,
                        status: 'usrrej'
                    })
                });
                
                if (response.ok) {
                    showInfo('Target rejected successfully', 'success');
                    loadTargets();
                    clearSelection();
                } else {
                    showInfo('Error rejecting target', 'error');
                }
                
            } catch (error) {
                console.error('Error rejecting target:', error);
                showInfo('Error rejecting target: ' + error.message, 'error');
            }
        }
        
        async function approveTarget() {
            if (!currentTarget) return;
            
            // Save rejected points if any
            if (rejectedPoints.size > 0) {
                const rejectedIndices = Array.from(rejectedPoints);
                await fetch('/api/target/save_rejected_points', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: currentTarget.date,
                        target_name: currentTarget.target_name,
                        filter: currentTarget.filter,
                        rejected_indices: rejectedIndices
                    })
                });
            }
            
            try {
                const response = await fetch('/api/target/update_status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: currentTarget.date,
                        target_name: currentTarget.target_name,
                        filter: currentTarget.filter,
                        status: 'approved'
                    })
                });
                
                if (response.ok) {
                    showInfo('Target approved! You can now submit to AAVSO.', 'success');
                    document.getElementById('btn-submit').style.display = 'inline-block';
                    loadTargets();
                } else {
                    showInfo('Error approving target', 'error');
                }
                
            } catch (error) {
                console.error('Error approving target:', error);
                showInfo('Error approving target: ' + error.message, 'error');
            }
        }
        
        async function submitToAAVSO() {
            if (!currentTarget) return;
            
            try {
                // First, rebuild AAVSO report with only approved (non-rejected) points
                const rebuildResponse = await fetch('/api/aavso/rebuild', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: currentTarget.date,
                        target_name: currentTarget.target_name,
                        filter: currentTarget.filter,
                        rejected_indices: Array.from(rejectedPoints)
                    })
                });
                
                if (!rebuildResponse.ok) {
                    const errorData = await rebuildResponse.json();
                    throw new Error(errorData.error || 'Failed to rebuild AAVSO report');
                }
                
                const rebuildData = await rebuildResponse.json();
                console.log('Rebuild response:', rebuildData);
                
                // Show detailed feedback about what was included
                const totalPoints = 126; // Total frames
                const includedMsg = `AAVSO Report Generated:\n` +
                    `‚úì ${rebuildData.points_included} observations included\n` +
                    `‚úó ${rebuildData.sigma_rejected || 0} rejected by sigma clipping\n` +
                    `‚úó ${rebuildData.user_rejected || 0} rejected by you\n` +
                    `Total: ${totalPoints} frames processed`;
                
                showInfo(includedMsg, 'success');
                
                // Now download the approved report
                const response = await fetch('/api/aavso/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: currentTarget.date,
                        target_name: currentTarget.target_name,
                        filter: currentTarget.filter
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `AAVSO_Report_${currentTarget.target_name}_${currentTarget.date}_approved.txt`;
                    a.click();
                    
                    // Update status
                    await fetch('/api/target/update_status', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            date: currentTarget.date,
                            target_name: currentTarget.target_name,
                            filter: currentTarget.filter,
                            status: 'submitted'
                        })
                    });
                    
                    showInfo(`‚úì AAVSO report downloaded successfully!\n‚úì ${rebuildData.points_included} observations ready for submission\n‚úì Status updated to 'submitted'`, 'success');
                    loadTargets();
                } else {
                    showInfo('Error downloading AAVSO report file', 'error');
                }
                
            } catch (error) {
                console.error('Error submitting to AAVSO:', error);
                showInfo('Error submitting to AAVSO: ' + error.message, 'error');
            }
        }
        
        function clearSelection() {
            currentTarget = null;
            lightcurveData = null;
            rejectedPoints.clear();
            
            document.querySelectorAll('.target-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            document.getElementById('controls').style.display = 'none';
            document.getElementById('lightcurve-plot').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìà</div>
                    <p>Select a target to view lightcurve</p>
                </div>
            `;
        }
        
        function showInfo(message, type = 'info') {
            const banner = document.getElementById('info-banner');
            banner.textContent = message;
            banner.className = 'info-banner show';
            
            if (type === 'success') {
                banner.style.background = '#d4edda';
                banner.style.borderColor = '#c3e6cb';
                banner.style.color = '#155724';
            } else if (type === 'error') {
                banner.style.background = '#f8d7da';
                banner.style.borderColor = '#f5c6cb';
                banner.style.color = '#721c24';
            }
            
            setTimeout(() => {
                banner.classList.remove('show');
            }, 5000);
        }
    </script>
</body>
</html>
